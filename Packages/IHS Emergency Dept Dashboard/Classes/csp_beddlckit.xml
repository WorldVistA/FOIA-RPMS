<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25" zv="Cache for UNIX (Red Hat Enterprise Linux for x86-64) 2014.1.3 (Build 775U)" ts="2019-07-17 13:16:22">
<Class name="csp.beddlckit">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeChanged>64672,29653.831044</TimeChanged>
<TimeCreated>64672,29653.827727</TimeCreated>
<GeneratedBy>/csp/foia_goldb/BEDDLCKIT.csp</GeneratedBy>

<Method name="CheckLock">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec>objid:%String,dfn:%String</FormalSpec>
<Language>cache</Language>
<Implementation><![CDATA[
 	
 	Set edvst=##class(BEDD.EDVISIT).%OpenId(objid)
 	
 	// Check to see if record is locked if it is not locked or
 	// if this user has it locked then go to the edit page
 	If (+edvst.RecLock=0)||((+edvst.RecLock=1)&&(edvst.RecLockUser=%session.Data("DUZ"))) {
 		Set edvst.RecLock=1,edvst.RecLockDT=$H,edvst.RecLockUser=%session.Data("DUZ")
 	
 		//BEDD*2.0*1;Added setting of new RecLockSite property
 		Set edvst.RecLockSite=$G(%session.Data("SITE"))
 		Set save=edvst.%Save()
 		Set edvst=""
 	
 		//BEDD*2.0*2;Set up patient session variables
 		Set %session.Data("DFN")=dfn
 		Set %session.Data("OBJECTID")=objid
 		Set %session.Data("EDVISITID")=objid
 		
 		Quit ""
 
 	}
 	Else {
 		Set uien=edvst.RecLockUser,editdt=edvst.RecLockDT,myLock=edvst.RecLock 
 		Set edvst="",user="No Such User"
 		Set:uien]"" user=$$GET1^DIQ(200,uien_",",".01","I"),lock=1
 		Set ErrorMessage = "RECORD IS BEING UPDATED BY "_user_" "_($$HTE^XLFDT(editdt,"5Z"))
 		//Current user is: #($$GET1^DIQ(200,%session.Data("DUZ"),".01","I"))# <br>
  
 		Quit ErrorMessage
 	}
 	
 
]]></Implementation>
</Method>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""EditPatient()"">"
	Write !,!,"</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<!-- BEDDLCKIT.csp - BEDD ED Locking Page -->"
	Write !,"<!-- ;;2.0;IHS EMERGENCY DEPT DASHBOARD;**1,2**;Apr 02, 2014 -->"
	Write !,"<!-- BEDD*2.0*2;Set up %Session variables to enable log out button on dashboard -->"
	Write !
	Do ..OnPageHTML()
	Write !,!,"<script language=""javascript"" type=""text/javascript"">"
	Write !,!,"function EditPatient() {	",!
	Write !,"	//Make sure user is logged in",!
	Write !,"	//Get user",!
	Write "	var user = "_("cspHttpServerMethod")_"('"_(..Encrypt($listbuild($classname()_".ReturnDUZ"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"') ;	",!
	Write "	if (user == 0) {",!
	Write "		alert(""User has been logged out"");",!
	Write "		location.replace='BEDDLogin.csp';",!
	Write "		return true;",!
	Write "	}",!
	Write !,"	var tobjid = "_(objid)_";",!
	Write "	var tdfn = "_(dfn),!
	Write "	",!
	Write "	//Check if locked",!
	Write "	var check = "_("cspHttpServerMethod")_"('"_(..Encrypt($listbuild($classname()_".CheckLock"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',tobjid,tdfn);",!
	Write "	",!
	Write "	//If success go to edit page",!
	Write "	if (check == """") {",!
	Write "		self.document.location.replace = ""BEDDEDIT1.csp?OBJID="_(%session.Data("OBJECTID"))_"&DFN="_(%session.Data("DFN"))_""" ;",!
	Write "		return true;",!
	Write "	}",!
	Write "	else {",!
	Write "		alert(check);",!
	Write "		location.replace='BEDD.csp'",!
	Write "	}",!
	Write "}",!
	Write !,"</script>"
	Write !,!,!,"	",!
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,!
	Set U="^",site=%session.Data("SITE")
	Do LOADSYS^BEDDUTW(.beddsys,site)
	Set timeout=$G(beddsys("TimeOut"))
	Write !,!,"<META HTTP-EQUIV=""Refresh"" CONTENT="""_( timeout )_"; URL=BEDD.csp"">"
	Write !,(..HyperEventHead(0,0))
	Write !,!,!,!,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html>"
	Write !
	Do ..OnPageHEAD()
	Write !
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
 	Set dfn=%request.Get("DFN"),objid=%request.Get("OBJID")
 	//Set edvst=##class(BEDD.EDVISIT).%OpenId(objid)
 	//set (uien,user,lock)=0,editdt=""
 	// Check to see if record is locked if it is not locked or
 	// if this user has it locked then go to the edit page
 	//If (+edvst.RecLock=0)||((+edvst.RecLock=1)&&(edvst.RecLockUser=%session.Data("DUZ"))) {
 	//	Set edvst.RecLock=1,edvst.RecLockDT=$H,edvst.RecLockUser=%session.Data("DUZ")
 	//	//BEDD*2.0*1;Added setting of new RecLockSite property
 	//	Set edvst.RecLockSite=$G(%session.Data("SITE"))
 	//	Set save=edvst.%Save()
 	//	Set edvst=""
 	//	//BEDD*2.0*2;Set up patient session variables
 	//	Set %session.Data("DFN")=dfn
 	//	Set %session.Data("OBJECTID")=objid
 	//	Set %session.Data("EDVISITID")=objid
 	//	Set %response.Redirect="BEDDEDIT1.csp?OBJID="_objid_"&DFN="_dfn
 	//	Q 1
 	//}
 	// Otherwise tell this user that the record is locked and the user that has it locked
 	//Else {
 	//	Set uien=edvst.RecLockUser,editdt=edvst.RecLockDT,myLock=edvst.RecLock 
 	//	Set edvst="",user="No Such User"
 	//	Set:uien]"" user=$$GET1^DIQ(200,uien_",",".01","I"),lock=1
 	//	Q 1
 	//}
 	
 	Quit 1
 	
 
]]></Implementation>
</Method>

<Method name="ReturnDUZ">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<Implementation><![CDATA[
 	Set user=$Get(%session.Data("DUZ"))
 	If (user<1) {
 		Set user=0
 	}
 
 	Quit user
 
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>D:\intersystems\E3IHS\CSP\foia_goldb\BEDDLCKIT.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/foia_goldb/BEDDLCKIT.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>64671,78206</Default>
</Parameter>
</Class>
</Export>
